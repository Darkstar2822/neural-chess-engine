<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neural Chess Engine - Advanced Interface</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chess.css') }}">
</head>
<body>
    <div class="chess-container">
        <div class="game-wrapper">
            <!-- Chess Board Section -->
            <div class="board-section">
                <h1 style="text-align: center; margin-bottom: 20px; color: #333;">Neural Chess Engine</h1>
                <div class="chess-board">
                    <div id="chess-board" class="board-inner">
                        <!-- Board squares will be generated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- Controls Panel -->
            <div class="controls-panel">
                <div class="game-status">
                    <h3 style="margin: 0 0 15px 0; color: #333;">Game Status</h3>
                    <div class="status-item">
                        <span class="status-label">Status:</span>
                        <span id="gameStatus" class="status-value">Ready to start</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Turn:</span>
                        <span id="currentTurn" class="status-value">-</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Moves:</span>
                        <span id="moveCount" class="status-value">0</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Learning:</span>
                        <span id="learningStatus" class="status-value">üß† Enabled</span>
                    </div>
                </div>
                
                <div class="learning-stats" id="learningInfo" style="display: none;">
                    <h4>üß† AI Learning Stats</h4>
                    <div class="status-item">
                        <span class="status-label">Games vs You:</span>
                        <span id="userGames" class="status-value">0</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">AI Win Rate:</span>
                        <span id="aiWinRate" class="status-value">0%</span>
                    </div>
                </div>
                
                <div class="model-info">
                    <h4 style="margin: 0 0 10px 0; color: #333;">ü§ñ Model Information</h4>
                    <div class="status-item">
                        <span class="status-label">Model:</span>
                        <span id="modelName" class="status-value">Loading...</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Type:</span>
                        <span id="modelType" class="status-value">-</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Architecture:</span>
                        <span id="modelArch" class="status-value">-</span>
                    </div>
                </div>
                
                <div class="control-buttons game-controls">
                    <button class="btn btn-primary" onclick="chessBoard.startNewGame('white')">
                        ‚ôî Play as White
                    </button>
                    <button class="btn btn-primary" onclick="chessBoard.startNewGame('black')">
                        ‚ôö Play as Black
                    </button>
                    <button class="btn btn-secondary" onclick="location.reload()">
                        üîÑ Reset Game
                    </button>
                    <button class="btn btn-secondary" onclick="testDragDrop()">
                        üîß Test Drag & Drop
                    </button>
                </div>
                
                <div class="move-input-section">
                    <h4 style="margin: 0 0 10px 0; color: #333;">Manual Move Input</h4>
                    <input type="text" id="manualMoveInput" class="move-input" 
                           placeholder="Enter move (e.g., e2e4)" 
                           onkeypress="handleManualMoveInput(event)">
                    <button class="btn btn-success" onclick="makeManualMove()">
                        ‚ñ∂ Make Move
                    </button>
                    <p style="font-size: 12px; color: #666; margin: 5px 0 0 0;">
                        You can also drag & drop pieces on the board
                    </p>
                </div>
                
                <div class="game-status">
                    <h4 style="margin: 0 0 10px 0; color: #333;">How to Play</h4>
                    <ul style="font-size: 13px; color: #555; margin: 0; padding-left: 20px;">
                        <li>üñ±Ô∏è <strong>Click & Click:</strong> Click piece, then destination</li>
                        <li>üñ±Ô∏è <strong>Drag & Drop:</strong> Drag pieces to move them</li>
                        <li>‚å®Ô∏è <strong>Type Moves:</strong> Use algebraic notation (e2e4)</li>
                        <li>‚ôüÔ∏è <strong>Special Moves:</strong> En passant, castling, promotion</li>
                        <li>üé® <strong>Visual Hints:</strong> Orange=en passant, Purple=castling</li>
                        <li>üß† <strong>AI Learning:</strong> Engine adapts to your playing style</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Message Area -->
    <div id="message-area" class="message-area"></div>
    
    <!-- Preload chess piece images for smooth experience -->
    <div class="piece-preload">
        <img src="/static/images/wk.png" alt="White King">
        <img src="/static/images/wq.png" alt="White Queen">
        <img src="/static/images/wr.png" alt="White Rook">
        <img src="/static/images/wb.png" alt="White Bishop">
        <img src="/static/images/wn.png" alt="White Knight">
        <img src="/static/images/wp.png" alt="White Pawn">
        <img src="/static/images/bk.png" alt="Black King">
        <img src="/static/images/bq.png" alt="Black Queen">
        <img src="/static/images/br.png" alt="Black Rook">
        <img src="/static/images/bb.png" alt="Black Bishop">
        <img src="/static/images/bn.png" alt="Black Knight">
        <img src="/static/images/bp.png" alt="Black Pawn">
    </div>
    
    <script src="{{ url_for('static', filename='js/chess-board.js') }}"></script>
    <script>
        function handleManualMoveInput(event) {
            if (event.key === 'Enter') {
                makeManualMove();
            }
        }
        
        function testDragDrop() {
            console.log('=== DRAG & DROP TEST ===');
            console.log('Game state:', chessBoard.gameState);
            
            const pieces = document.querySelectorAll('.piece');
            console.log(`Found ${pieces.length} pieces on board`);
            
            pieces.forEach((piece, index) => {
                console.log(`Piece ${index}: ${piece.dataset.piece}, draggable: ${piece.draggable}, parent: ${piece.parentElement.id}`);
            });
            
            const whitePawn = document.querySelector('[data-piece="P"]');
            if (whitePawn) {
                console.log('Testing white pawn:', whitePawn);
                console.log('Can move:', chessBoard.canMovePiece(whitePawn));
            }
        }

        function makeManualMove() {
            const move = document.getElementById('manualMoveInput').value.trim();
            if (!move) {
                chessBoard.showMessage('Please enter a move', 'error');
                return;
            }
            
            // Handle promotion moves like e7e8q
            if (move.length === 5 && move.match(/^[a-h][1-8][a-h][1-8][qrbn]$/)) {
                chessBoard.makeMove(move);
            } else if (move.length === 4 && move.match(/^[a-h][1-8][a-h][1-8]$/)) {
                // Check if this is a promotion move
                if (chessBoard.isPromotionMove(move.substring(0, 2), move.substring(2, 4))) {
                    chessBoard.showPromotionDialog(move.substring(0, 2), move.substring(2, 4));
                } else {
                    chessBoard.makeMove(move);
                }
            } else {
                // Try to parse as algebraic notation
                chessBoard.makeMove(move);
            }
            
            document.getElementById('manualMoveInput').value = '';
        }
        
        // Update model information
        function updateModelInfo() {
            fetch('/api/current_model')
                .then(response => response.json())
                .then(data => {
                    if (data.name) {
                        document.getElementById('modelName').textContent = data.name;
                        document.getElementById('modelType').textContent = data.type || 'standard';
                        document.getElementById('modelArch').textContent = data.architecture || 'ChessNet';
                    }
                })
                .catch(error => {
                    console.log('Could not fetch model info:', error);
                    document.getElementById('modelName').textContent = 'Unknown';
                });
        }

        // Welcome message and test
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Chess engine loaded successfully!');
            console.log('ChessBoard object:', chessBoard);
            
            // Update model information
            updateModelInfo();
            
            setTimeout(() => {
                chessBoard.showMessage('Welcome! Start a new game to play against the neural chess engine. Drag & drop pieces or click to move!', 'info');
            }, 1000);
        });
    </script>
</body>
</html>